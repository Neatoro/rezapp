name: ci

on:
    push:
        branches:
            - '*'

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Build and export backend
              uses: docker/build-push-action@v3
              with:
                  context: src/backend
                  tags: rezapp-backend:latest
                  outputs: type=docker,dest=/tmp/backend.tar

            - name: Build and export frontend
              uses: docker/build-push-action@v3
              with:
                  context: src/frontend
                  tags: rezapp-frontend:latest
                  outputs: type=docker,dest=/tmp/frontend.tar

            - name: Upload backend artifact
              uses: actions/upload-artifact@v3
              with:
                  name: backend
                  path: /tmp/backend.tar

            - name: Upload frontend artifact
              uses: actions/upload-artifact@v3
              with:
                  name: frontend
                  path: /tmp/frontend.tar

    api-tests:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Download artifact
              uses: actions/download-artifact@v3
              with:
                  name: backend
                  path: /tmp

            - name: Build api-tests image
              uses: docker/build-push-action@v3
              with:
                  context: .
                  tags: api-tests:latest
                  file: pipeline/stages/api-tests/Dockerfile
                  outputs: type=docker,dest=/tmp/api-tests.tar

            - name: Build mock proxy image
              uses: docker/build-push-action@v3
              with:
                  context: .
                  tags: mock-proxy:latest
                  file: mocks/proxy/Dockerfile
                  outputs: type=docker,dest=/tmp/proxy-mock.tar

            - name: Prepare docker
              run: |
                  docker load --input /tmp/backend.tar
                  docker load --input /tmp/api-tests.tar
                  docker load --input /tmp/proxy-mock.tar

            - name: Start landscape
              uses: isbang/compose-action@v1.4.1
              with:
                compose-file: ./pipeline/stages/api-tests/docker-compose.yml
                up-flags: "-d"

            - name: Wait for server to start
              uses: ifaxity/wait-on-action@v1
              with:
                  resource: http-get://localhost:8080/recipe

            - name: Run API tests
              run: |
                  docker run --rm --network rezapp --name api-tests -v rezapp-database:/database api-tests

            - name: Logs landscape
              if: always()
              run: |
                  docker-compose -f pipeline/stages/api-tests/docker-compose.yaml logs

    e2e-tests:
        if: ${{ false }}
        runs-on: ubuntu-latest
        needs: build

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v3

            - name: Setup Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Download backend artifact
              uses: actions/download-artifact@v3
              with:
                  name: backend
                  path: /tmp

            - name: Download frontend artifact
              uses: actions/download-artifact@v3
              with:
                  name: frontend
                  path: /tmp

            - name: Build e2e image
              uses: docker/build-push-action@v3
              with:
                  context: .
                  tags: e2e-tests:latest
                  file: pipeline/stages/e2e-tests/Dockerfile
                  outputs: type=docker,dest=/tmp/e2e-tests.tar

            - name: Prepare docker
              run: |
                  docker load --input /tmp/backend.tar
                  docker load --input /tmp/frontend.tar
                  docker load --input /tmp/e2e-tests.tar

            - name: Start landscape
              run: |
                  docker-compose -f pipeline/stages/e2e-tests/docker-compose.yaml up -d

            - name: Wait for server to start
              uses: ifaxity/wait-on-action@v1
              with:
                  resource: http-get://localhost:8000/api/recipe

            - name: Run E2E tests
              run: |
                  docker run --rm --network rezapp --name e2e-tests -v rezapp-database:/database e2e-tests

            - name: Logs landscape
              if: always()
              run: |
                  docker-compose -f pipeline/stages/e2e-tests/docker-compose.yaml logs
